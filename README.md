# Инструкция по развертыванию проекта

## Структура проекта

Проект представляет собой бэкенд для читалки манги, написанный на Go. Основные компоненты:

- **API сервер**: обрабатывает HTTP запросы
- **PostgreSQL**: хранит данные о манге, главах, пользователях и т.д.
- **Redis**: используется для хранения токенов и кэширования
- **Swagger**: документация API

## Необходимые инструменты

- Go 1.22 или новее
- Docker и Docker Compose
- Git

## Подготовка к запуску

1. Клонируйте репозиторий:
   ```bash
   git clone https://github.com/LirikaOne-Back/manga-reader3.git
   cd manga-reader3
   ```

2. Создайте файл `.env` на основе `.env.example`:
   ```bash
   cp .env.example .env
   ```

3. Настройте параметры в файле `.env` под свои нужды.

## Запуск с использованием Docker

1. Соберите и запустите контейнеры:
   ```bash
   docker-compose up -d
   ```

2. Проверьте, что контейнеры запущены:
   ```bash
   docker-compose ps
   ```

3. API будет доступен по адресу `http://localhost:8081`
4. Swagger UI будет доступен по адресу `http://localhost:8081/swagger/index.html`
5. PgAdmin будет доступен по адресу `http://localhost:5050` (логин: admin@manga.com, пароль: admin)

## Используемые порты

В конфигурации Docker Compose используются следующие порты:

- **API сервер**: 8081 (снаружи) -> 8080 (внутри контейнера)
- **PostgreSQL**: 5433 (снаружи) -> 5432 (внутри контейнера)
- **Redis**: 6389 (снаружи) -> 6379 (внутри контейнера)
- **pgAdmin**: 5050 (снаружи) -> 80 (внутри контейнера)

Если какой-то из этих портов занят на вашей системе, вы можете изменить их в файле `docker-compose.yml`.

## Запуск без Docker (для разработки)

1. Убедитесь, что PostgreSQL и Redis запущены и доступны.

2. Обновите файл `.env`, указав правильные адреса для подключения к PostgreSQL и Redis.

3. Установите зависимости:
   ```bash
   go mod download
   ```

4. Запустите приложение:
   ```bash
   go run cmd/api/main.go
   ```

## Генерация документации Swagger

Для обновления документации Swagger используйте инструмент swag:

```bash
# Установка swag
go install github.com/swaggo/swag/cmd/swag@latest

# Генерация документации
swag init -g cmd/api/main.go
```

## Основные эндпоинты API

- **GET /api/manga** - получение списка манги с фильтрами
- **GET /api/manga/{id}** - получение детальной информации о манге
- **GET /api/chapters/manga/{manga_id}** - получение списка глав манги
- **GET /api/chapters/{id}/pages** - получение страниц главы
- **POST /api/auth/signup** - регистрация нового пользователя
- **POST /api/auth/login** - авторизация пользователя

## Структура базы данных

База данных содержит следующие основные таблицы:
- `users` - пользователи системы
- `manga` - информация о манге
- `genres` - жанры манги
- `manga_genres` - связь манги и жанров
- `chapters` - главы манги
- `pages` - страницы глав
- `bookmarks` - закладки пользователей
- `read_history` - история чтения

## Решение проблем

При возникновении ошибок проверьте:
1. Правильность настроек в файле `.env`
2. Доступность PostgreSQL и Redis
3. Логи контейнеров: `docker-compose logs -f`

### Типичные ошибки и их решения

- **Ошибка "port is already allocated"**: измените порты в docker-compose.yml, как описано в разделе "Используемые порты"
- **Ошибка подключения к базе данных**: проверьте настройки подключения и убедитесь, что база данных запущена
- **Ошибка подключения к Redis**: проверьте настройки подключения и пароль Redis

## Дополнительные команды

- Остановка контейнеров: `docker-compose down`
- Перезапуск контейнеров: `docker-compose restart`
- Просмотр логов: `docker-compose logs -f [service_name]`
- Просмотр структуры базы данных через pgAdmin: подключитесь к серверу с хостом `postgres`, портом `5432` (внутри сети Docker) и учетными данными из `.env`

## Работа с приложением через Windows

1. Установите Docker Desktop для Windows.
2. Включите WSL 2 (Windows Subsystem for Linux) если используете Windows 10/11.
3. Убедитесь, что Docker настроен на использование WSL 2.
4. Далее следуйте инструкциям по запуску с использованием Docker.

## Продакшн деплой

Для продакшн окружения рекомендуется:
1. Использовать SSL/TLS сертификаты
2. Настроить более безопасный пароль для БД
3. Ограничить доступ к админ-панели
4. Настроить бэкапы данных
5. Установить мониторинг (Prometheus + Grafana)